<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Google Drive Music Player (No Artwork)</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #121212;
    color: #eee;
    margin: 0;
    display: flex;
    height: 100vh;
    flex-direction: column;
  }
  header {
    padding: 10px 20px;
    background: #1db954;
    font-weight: bold;
    font-size: 1.2rem;
  }
  main {
    flex: 1;
    display: flex;
    gap: 20px;
    padding: 20px;
    background: #181818;
  }
  .sidebar {
    width: 220px;
    display: flex;
    flex-direction: column;
  }
  .sidebar input, .sidebar button {
    margin-bottom: 10px;
    padding: 8px;
    font-size: 1rem;
  }
  .sidebar button {
    background: #1db954;
    border: none;
    color: #fff;
    cursor: pointer;
    border-radius: 4px;
  }
  .playlists {
    flex: 1;
    overflow-y: auto;
  }
  .playlists button {
    width: 100%;
    text-align: left;
    background: transparent;
    border: none;
    color: #ccc;
    padding: 6px 8px;
    cursor: pointer;
    border-radius: 4px;
  }
  .playlists button.active, .playlists button:hover {
    background: #1db954;
    color: #000;
  }
  .content {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #222;
    border-radius: 8px;
    overflow: hidden;
  }
  .controls {
    background: #111;
    padding: 10px;
    display: flex;
    gap: 10px;
    justify-content: center;
    align-items: center;
  }
  .controls button {
    background: transparent;
    border: none;
    color: #1db954;
    font-size: 1.5rem;
    cursor: pointer;
  }
  #searchInput {
    padding: 10px;
    border: none;
    font-size: 1rem;
    outline: none;
    width: 100%;
    box-sizing: border-box;
  }
  .track-list {
    flex: 1;
    overflow-y: auto;
    background: #181818;
  }
  .track {
    padding: 10px 15px;
    border-bottom: 1px solid #333;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .track.active {
    background: #1db954;
    color: #000;
  }
  .track button {
    background: transparent;
    border: none;
    color: #1db954;
    font-size: 1.2rem;
    cursor: pointer;
  }
  .playlist-tracks {
    flex: 1;
    overflow-y: auto;
    background: #181818;
  }
  .playlist-track {
    padding: 10px 15px;
    border-bottom: 1px solid #333;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: grab;
  }
  .playlist-track.dragging {
    opacity: 0.5;
  }
</style>
</head>
<body>

<header>Google Drive Music Player</header>

<main>
  <section class="sidebar">
    <input type="text" id="newPlaylistName" placeholder="New playlist name" />
    <button id="createPlaylistBtn">Create Playlist</button>
    <div class="playlists" id="playlists"></div>
    <button id="loadAllBtn">Load All Songs</button>
  </section>

  <section class="content">
    <input type="text" id="searchInput" placeholder="Search songs..." />
    <div class="track-list" id="trackList"></div>
    <div class="playlist-tracks" id="playlistTracks" style="display:none;"></div>
    <div class="controls">
      <button id="prevBtn">‚èÆÔ∏è</button>
      <button id="playPauseBtn">‚ñ∂Ô∏è</button>
      <button id="nextBtn">‚è≠Ô∏è</button>
      <button id="shuffleBtn">üîÄ Off</button>
      <button id="repeatBtn">üîÅ Off</button>
    </div>
    <audio id="audio" crossorigin="anonymous"></audio>
  </section>
</main>

<script>
  const folderId = '1DGz9zEQh29EAqTZpmWK5mwSj5HComnkn'; // Your Google Drive folder ID
  const apiKey = 'AIzaSyDsYE91wH7UDwu8eZNbD1CFuVcilgYeZhI'; // Your Google API key

  const playlistsEl = document.getElementById('playlists');
  const newPlaylistNameInput = document.getElementById('newPlaylistName');
  const createPlaylistBtn = document.getElementById('createPlaylistBtn');
  const loadAllBtn = document.getElementById('loadAllBtn');
  const searchInput = document.getElementById('searchInput');
  const trackListEl = document.getElementById('trackList');
  const playlistTracksEl = document.getElementById('playlistTracks');
  const audio = document.getElementById('audio');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const shuffleBtn = document.getElementById('shuffleBtn');
  const repeatBtn = document.getElementById('repeatBtn');

  let tracks = [];             // All tracks from Google Drive
  let filteredTracks = [];     // Tracks currently shown (all or filtered)
  let playlists = JSON.parse(localStorage.getItem('gdrive_playlists') || '{}');
  let currentPlaylist = null;  // Name of current playlist or null for all
  let currentTrackIndex = -1;
  let isPlaying = false;
  let shuffleMode = false;
  let repeatMode = 0; // 0: off, 1: all, 2: one

  // Save playlists to localStorage
  function savePlaylists() {
    localStorage.setItem('gdrive_playlists', JSON.stringify(playlists));
  }

  // Load all audio files from Google Drive folder
  async function loadAllTracks() {
    let pageToken = '';
    let allFiles = [];
    const mimeTypes = [
      "audio/mpeg", "audio/mp4", "audio/x-wav", "audio/wav", "audio/aac", "audio/x-m4a"
    ];
    try {
      do {
        const q = encodeURIComponent(`'${folderId}' in parents and (${mimeTypes.map(m => `mimeType='${m}'`).join(' or ')})`);
        const url = `https://www.googleapis.com/drive/v3/files?q=${q}&fields=nextPageToken,files(id,name,mimeType)&pageSize=100${pageToken ? '&pageToken=' + pageToken : ''}&key=${apiKey}`;
        const res = await fetch(url);
        const data = await res.json();
        if(data.files) allFiles = allFiles.concat(data.files);
        pageToken = data.nextPageToken || '';
      } while(pageToken);
      tracks = allFiles.sort((a,b) => a.name.localeCompare(b.name));
      filteredTracks = tracks;
      currentPlaylist = null;
      renderTracks();
      renderPlaylists();
      showTrackList();
      currentTrackIndex = -1;
      pauseAudio();
    } catch(e) {
      alert('Failed to load tracks from Google Drive.');
      console.error(e);
    }
  }

  // Render all tracks (either filtered or playlist)
  function renderTracks() {
    trackListEl.innerHTML = '';
    if(filteredTracks.length === 0){
      trackListEl.textContent = 'No songs found.';
      return;
    }
    filteredTracks.forEach((track, i) => {
      const div = document.createElement('div');
      div.className = 'track' + (i === currentTrackIndex ? ' active' : '');
      div.textContent = track.name;
      div.onclick = () => playTrack(i);
      // Add "Add to Playlist" button if in all songs view
      if(currentPlaylist === null){
        const addBtn = document.createElement('button');
        addBtn.textContent = '+';
        addBtn.title = 'Add to playlist';
        addBtn.onclick = e => {
          e.stopPropagation();
          showAddToPlaylistMenu(e, track);
        };
        div.appendChild(addBtn);
      }
      trackListEl.appendChild(div);
    });
  }

  // Show playlist names in sidebar
  function renderPlaylists() {
    playlistsEl.innerHTML = '';
    Object.keys(playlists).forEach(name => {
      const btn = document.createElement('button');
      btn.textContent = name;
      if(name === currentPlaylist) btn.classList.add('active');
      btn.onclick = () => selectPlaylist(name);
      playlistsEl.appendChild(btn);
    });
  }

  // Select and show a playlist
  function selectPlaylist(name) {
    currentPlaylist = name;
    filteredTracks = playlists[name];
    renderTracks();
    renderPlaylists();
    showTrackList();
    currentTrackIndex = -1;
    pauseAudio();
  }

  // Play a track by index
  function playTrack(index) {
    if(index < 0 || index >= filteredTracks.length) return;
    currentTrackIndex = index;
    const track = filteredTracks[index];
    audio.src = `https://www.googleapis.com/drive/v3/files/${track.id}?alt=media&key=${apiKey}`;
    audio.play();
    isPlaying = true;
    updatePlayPauseBtn();
    renderTracks();
  }

  // Play/pause toggle
  function togglePlayPause() {
    if(isPlaying){
      pauseAudio();
    } else {
      if(currentTrackIndex === -1 && filteredTracks.length) playTrack(0);
      else audio.play();
      isPlaying = true;
      updatePlayPauseBtn();
    }
  }

  function pauseAudio() {
    audio.pause();
    isPlaying = false;
    updatePlayPauseBtn();
  }

  function updatePlayPauseBtn() {
    playPauseBtn.textContent = isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
  }

  // Next track (consider shuffle and repeat)
  function nextTrack() {
    if(filteredTracks.length === 0) return;
    if(repeatMode === 2){
      playTrack(currentTrackIndex); // repeat one
      return;
    }
    if(shuffleMode){
      let next = Math.floor(Math.random() * filteredTracks.length);
      while(next === currentTrackIndex && filteredTracks.length > 1){
        next = Math.floor(Math.random() * filteredTracks.length);
      }
      playTrack(next);
    } else {
      let next = currentTrackIndex + 1;
      if(next >= filteredTracks.length){
        if(repeatMode === 1) next = 0;
        else { pauseAudio(); return; }
      }
      playTrack(next);
    }
  }

  // Previous track
  function prevTrack() {
    if(filteredTracks.length === 0) return;
    let prev = currentTrackIndex - 1;
    if(prev < 0){
      if(repeatMode === 1) prev = filteredTracks.length - 1;
      else { pauseAudio(); return; }
    }
    playTrack(prev);
  }

  // Shuffle toggle
  function toggleShuffle() {
    shuffleMode = !shuffleMode;
    shuffleBtn.textContent = shuffleMode ? 'üîÄ On' : 'üîÄ Off';
  }

  // Repeat toggle: off -> all -> one -> off
  function toggleRepeat() {
    repeatMode = (repeatMode + 1) % 3;
    const text = ['Off', 'All', 'One'][repeatMode];
    repeatBtn.textContent = 'üîÅ ' + text;
  }

  // Search tracks by name
  searchInput.addEventListener('input', () => {
    const q = searchInput.value.trim().toLowerCase();
    if(currentPlaylist === null){
      filteredTracks = tracks.filter(t => t.name.toLowerCase().includes(q));
    } else {
      filteredTracks = playlists[currentPlaylist].filter(t => t.name.toLowerCase().includes(q));
    }
    renderTracks();
  });

  // Create new playlist
  createPlaylistBtn.onclick = () => {
    const name = newPlaylistNameInput.value.trim();
    if(!name){
      alert('Please enter playlist name');
      return;
    }
    if(playlists[name]){
      alert('Playlist already exists');
      return;
    }
    playlists[name] = [];
    savePlaylists();
    renderPlaylists();
    newPlaylistNameInput.value = '';
  };

  // Show Add to Playlist Menu (simple prompt)
  function showAddToPlaylistMenu(e, track){
    const names = Object.keys(playlists);
    if(names.length === 0){
      alert('No playlists. Create one first.');
      return;
    }
    const playlistName = prompt('Add "' + track.name + '" to playlist:\n' + names.join('\n'));
    if(playlistName && playlists[playlistName]){
      // Avoid duplicates
      if(!playlists[playlistName].some(t => t.id === track.id)){
        playlists[playlistName].push(track);
        savePlaylists();
        alert('Added to ' + playlistName);
      } else {
        alert('Track already in playlist');
      }
    } else {
      alert('Playlist not found');
    }
  }

  // Show track list, hide playlist track editing
  function showTrackList(){
    trackListEl.style.display = 'block';
    playlistTracksEl.style.display = 'none';
  }

  // Drag & drop reorder for playlist tracks
  function enableDragDrop(){
    let draggedIndex = null;

    playlistTracksEl.addEventListener('dragstart', e => {
      if(!e.target.classList.contains('playlist-track')) return;
      draggedIndex = Number(e.target.dataset.index);
      e.target.classList.add('dragging');
    });

    playlistTracksEl.addEventListener('dragend', e => {
      if(!e.target.classList.contains('playlist-track')) return;
      e.target.classList.remove('dragging');
      draggedIndex = null;
    });

    playlistTracksEl.addEventListener('dragover', e => {
      e.preventDefault();
      const afterElement = getDragAfterElement(e.clientY);
      const draggingEl = playlistTracksEl.querySelector('.dragging');
      if(afterElement == null){
        playlistTracksEl.appendChild(draggingEl);
      } else {
        playlistTracksEl.insertBefore(draggingEl, afterElement);
      }
    });

    function getDragAfterElement(y){
      const draggableElements = [...playlistTracksEl.querySelectorAll('.playlist-track:not(.dragging)')];
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if(offset < 0 && offset > closest.offset){
          return {offset: offset, element: child};
        } else {
          return closest;
        }
      }, {offset: Number.NEGATIVE_INFINITY}).element;
    }
  }

  // Render playlist tracks for reordering/removing
  function renderPlaylistTracks(){
    if(currentPlaylist === null) return;
    playlistTracksEl.innerHTML = '';
    playlistTracksEl.style.display = 'block';
    trackListEl.style.display = 'none';

    playlists[currentPlaylist].forEach((track, i) => {
      const div = document.createElement('div');
      div.className = 'playlist-track';
      div.textContent = track.name;
      div.setAttribute('draggable', 'true');
      div.dataset.index = i;

      // Remove button
      const remBtn = document.createElement('button');
      remBtn.textContent = '‚úñ';
      remBtn.title = 'Remove from playlist';
      remBtn.onclick = e => {
        e.stopPropagation();
        playlists[currentPlaylist].splice(i, 1);
        savePlaylists();
        renderPlaylistTracks();
        filteredTracks = playlists[currentPlaylist];
        renderTracks();
        pauseAudio();
      };
      div.appendChild(remBtn);

      div.onclick = () => playTrack(i);

      playlistTracksEl.appendChild(div);
    });
  }

  // Update playlist tracks order after drag & drop
  playlistTracksEl.addEventListener('drop', () => {
    if(currentPlaylist === null) return;
    const newOrder = [];
    playlistTracksEl.querySelectorAll('.playlist-track').forEach(div => {
      const idx = Number(div.dataset.index);
      newOrder.push(playlists[currentPlaylist][idx]);
    });
    playlists[currentPlaylist] = newOrder;
    savePlaylists();
    renderPlaylistTracks();
  });

  // Audio ended event: play next track
  audio.addEventListener('ended', () => {
    nextTrack();
  });

  // Button listeners
  playPauseBtn.onclick = togglePlayPause;
  prevBtn.onclick = prevTrack;
  nextBtn.onclick = nextTrack;
  shuffleBtn.onclick = toggleShuffle;
  repeatBtn.onclick = toggleRepeat;
  loadAllBtn.onclick = loadAllTracks;

  // Initialize
  renderPlaylists();
  enableDragDrop();

  // Load tracks on start
  loadAllTracks();

</script>

</body>
</html>
